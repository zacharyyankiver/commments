"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.selectDefinition = selectDefinition;
exports.getDefinitionById = getDefinitionById;
const ora_1 = __importDefault(require("ora"));
const utils_1 = require("./utils");
const constants_1 = require("./constants");
async function fetchDefinitions(client, orgId) {
    try {
        const organization = await client.getOrganization(orgId);
        const batchedAppDefinitions = [];
        let skip = 0;
        let totalNumOfAppDefinitions = 0;
        while (skip === 0 || batchedAppDefinitions.length < totalNumOfAppDefinitions) {
            const appDefinitionsResponse = await organization.getAppDefinitions({ skip, limit: 100 });
            totalNumOfAppDefinitions = appDefinitionsResponse.total;
            batchedAppDefinitions.push(...appDefinitionsResponse.items);
            skip += 100;
        }
        return batchedAppDefinitions.map((def) => ({
            name: def.name,
            value: def.sys.id,
            locations: def.locations ? def.locations.map((location) => location.location) : [],
        }));
    }
    catch (err) {
        return (0, utils_1.throwError)(err, 'Could not fetch your app-definitions. Make sure you provided a valid access token.');
    }
}
async function selectDefinition(client, orgId) {
    const defSpinner = (0, ora_1.default)('Fetching all definitions...').start();
    const definitions = await fetchDefinitions(client, orgId);
    defSpinner.stop();
    return await (0, utils_1.selectFromList)(definitions, 'Select an app:', constants_1.APP_DEF_ENV_KEY);
}
async function getDefinitionById(client, orgId, defId) {
    try {
        const organization = await client.getOrganization(orgId);
        const definition = await organization.getAppDefinition(defId);
        return {
            name: definition.name,
            value: definition.sys.id,
            locations: definition.locations
                ? definition.locations.map((location) => location.location)
                : [],
        };
    }
    catch (err) {
        return (0, utils_1.throwError)(err, 'Could not fetch your app-definition. Make sure you provided a valid definition id or access token.');
    }
}
