"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.openSettings = openSettings;
const open_1 = __importDefault(require("open"));
const chalk_1 = __importDefault(require("chalk"));
const inquirer_1 = __importDefault(require("inquirer"));
const constants_1 = require("../constants");
const utils_1 = require("../utils");
async function openSettings(options) {
    let definitionId;
    const prompts = [];
    if (options.definitionId) {
        definitionId = options.definitionId;
    }
    else if (process.env[constants_1.APP_DEF_ENV_KEY]) {
        definitionId = process.env[constants_1.APP_DEF_ENV_KEY];
    }
    else {
        prompts.push({
            name: 'definitionId',
            message: `The id of the app:`,
        });
    }
    if (!options.host) {
        prompts.push({
            name: 'host',
            message: `Contentful CMA endpoint URL:`,
            default: constants_1.DEFAULT_CONTENTFUL_API_HOST,
        });
    }
    const openSettingsOptions = await inquirer_1.default.prompt(prompts);
    const hostValue = options.host || openSettingsOptions?.host;
    const appDefinitionIdValue = definitionId || openSettingsOptions?.definitionId;
    if (!appDefinitionIdValue) {
        console.log(`
        ${chalk_1.default.red('Error:')} There was no app-definition defined.

        Please add it with ${chalk_1.default.cyan('--definition-id=<app-definition-id>')}
        or set the environment variable ${chalk_1.default.cyan(`${constants_1.APP_DEF_ENV_KEY} = <app-definition-id>`)}
      `);
        throw new Error('No app-definition-id');
    }
    const webApp = (0, utils_1.getWebAppHostname)(hostValue);
    const redirectUrl = `https://${webApp}/deeplink?link=app-definition`;
    try {
        (0, open_1.default)(`${redirectUrl}&id=${appDefinitionIdValue}`);
    }
    catch (err) {
        console.log(`${chalk_1.default.red('Error:')} Failed to open browser`);
        console.log(err.message);
        throw err;
    }
}
